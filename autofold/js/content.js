const PORT_NAME="hand-data-port",RECONNECT_INTERVAL_MS=2e3,MAX_RECONNECT_ATTEMPTS=50;let port=null,reconnectAttempts=0,reconnectTimer=null,messageQueue=[];const MESSAGE_QUEUE_CAP=20;function connectPort(){try{return!chrome||!chrome.runtime||!chrome.runtime.id?!1:(port=chrome.runtime.connect({name:PORT_NAME}),port.onDisconnect.addListener(()=>{port=null,chrome.runtime.lastError,scheduleReconnect()}),reconnectAttempts=0,reconnectTimer&&(clearTimeout(reconnectTimer),reconnectTimer=null),flushMessageQueue(),!0)}catch{return port=null,!1}}function scheduleReconnect(){if(reconnectTimer||reconnectAttempts>=50)return;reconnectAttempts++;const t=Math.min(2e3*Math.pow(1.5,reconnectAttempts-1),3e4);reconnectTimer=setTimeout(()=>{reconnectTimer=null,connectPort()},t)}function sendPortMessage(t){if(port)try{return port.postMessage(t),!0}catch{port=null}return enqueueMessage(t),reconnectTimer||scheduleReconnect(),!1}function enqueueMessage(t){messageQueue.push(t),messageQueue.length>MESSAGE_QUEUE_CAP&&messageQueue.shift()}function flushMessageQueue(){for(;messageQueue.length>0&&port;){const t=messageQueue.shift();try{port.postMessage(t)}catch{messageQueue.unshift(t);break}}}connectPort();function safeGetURL(t){try{return!chrome||!chrome.runtime||!chrome.runtime.getURL?null:chrome.runtime.getURL(t)}catch{return null}}function safeStorageGet(t,e){try{if(!chrome||!chrome.storage||!chrome.storage.local){e&&e({});return}chrome.storage.local.get(t,r=>{if(chrome.runtime.lastError){e&&e({});return}e&&e(r||{})})}catch{e&&e({})}}function safeStorageSet(t,e){try{if(!chrome||!chrome.storage||!chrome.storage.local){e&&e();return}chrome.storage.local.set(t,()=>{if(chrome.runtime.lastError){e&&e();return}e&&e()})}catch{e&&e()}}function injectScript(t,e){try{const i=safeGetURL(t);if(!i)return;var r=document.getElementsByTagName(e)[0];if(!r)return;var o=document.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",i),r.appendChild(o)}catch{}}document.location.href.includes("pokernow.club")||document.location.href.includes("pokernow.com")?injectScript("js/scripts/pokernow.js","body"):document.location.href.includes("ignitioncasino.eu")&&injectScript("js/scripts/ignition.js","body");function compareHands(t,e){return!t||!e?!1:t.value1==e.value1&&t.suit1==e.suit1&&t.value2==e.value2&&t.suit2==e.suit2}const values=["2","3","4","5","6","7","8","9","10","J","Q","K","A"],DEFAULT_RANGE_VALUES=["A","K","Q","J","10","9","8","7","6","5","4","3","2"],DEFAULT_RANGE_SIZE=169;function buildDefaultRange(){const t=[];for(let e=0;e<DEFAULT_RANGE_VALUES.length;e++)for(let r=0;r<DEFAULT_RANGE_VALUES.length;r++)e>r?t.push(DEFAULT_RANGE_VALUES[r]+" "+DEFAULT_RANGE_VALUES[e]+" o"):t.push(DEFAULT_RANGE_VALUES[e]+" "+DEFAULT_RANGE_VALUES[r]+" s");return t}function normalizeRangeFold(t){const e=!Array.isArray(t?.range)||t.range.length!==DEFAULT_RANGE_SIZE,r=!Array.isArray(t?.fold)||t.fold.length!==DEFAULT_RANGE_SIZE,o=e?buildDefaultRange():t.range,i=r?new Array(DEFAULT_RANGE_SIZE).fill(!1):t.fold;return(e||r)&&safeStorageSet({range:o,fold:i}),{range:o,fold:i}}function checkRange(t){let e=!1;t.suit1==t.suit2&&(e=!0),safeStorageGet(["fold","range"],r=>{const{range:o,fold:i}=normalizeRangeFold(r||{});let n="",u=values.indexOf(t.value1),a=values.indexOf(t.value2);if(u===-1||a===-1){window.postMessage({type:"FROM_EXTENSION",text:!1},"*");return}u<a?n=`${t.value2} ${t.value1}`:n=`${t.value1} ${t.value2}`,t.value1==t.value2||e?n=n+" s":n=n+" o";let f=o.indexOf(n),l=f>=0?!!i[f]:!1;if(l==!1){const s=safeGetURL("media/alert.mp3");if(s){var c=new Audio(s);c.volume=.1,c.play().catch(()=>{})}}else safeStorageGet(["handsFolded"],s=>{let m=(s.handsFolded||0)+1;safeStorageSet({handsFolded:m})});window.postMessage({type:"FROM_EXTENSION",text:l},"*")})}var previousHand;window.addEventListener("message",t=>{if(t.source==window&&t.data.type&&t.data.type=="FROM_PAGE"){if(!t.data.text||typeof t.data.text!="string")return;let e;try{e=JSON.parse(t.data.text)}catch{return}if(!e||typeof e!="object"||typeof e.value1!="string"||typeof e.suit1!="string"||typeof e.value2!="string"||typeof e.suit2!="string")return;if(!compareHands(e,previousHand)){checkRange(e);const r={type:"HAND_DATA",data:{value1:e.value1,suit1:e.suit1,value2:e.value2,suit2:e.suit2,url:e.url,playerId:e.playerId,playerName:e.playerName,timestamp:Date.now()}};sendPortMessage(r)}previousHand=e}},!1);
