const values=["A","K","Q","J","10","9","8","7","6","5","4","3","2"];chrome.runtime.onInstalled.addListener(()=>{chrome.storage.local.set({handsFolded:0});let r=[];for(let s=0;s<values.length;s++)for(let t=0;t<values.length;t++)s>t?r.push(values[t]+" "+values[s]+" o"):r.push(values[s]+" "+values[t]+" s");chrome.storage.local.set({range:r});let e=new Array(169).fill(!1);chrome.storage.local.set({fold:e})});const AUTH_URL="https://dom-auth.onrender.com",HUB_HOST="dom-hub.onrender.com",MAX_RETRIES=100,INITIAL_BACKOFF_MS=1e3,MAX_BACKOFF_MS=1e4,AUTH_ERROR_BACKOFF_MS=6e4,QUEUE_CAP=100,RETRY_ALARM_NAME="hub-retry";function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const e=Math.random()*16|0;return(r=="x"?e:e&3|8).toString(16)})}async function getPublisherId(r){return new Promise(e=>{chrome.storage.local.get(["publisherIds"],s=>{let t=s.publisherIds||{};t[r]||(t[r]=generateUUID(),chrome.storage.local.set({publisherIds:t})),e(t[r])})})}async function fetchHubToken({roomId:r,role:e,publisherId:s}){try{const t=await fetch(`${AUTH_URL}/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room:r,role:e,publisherId:s})});return t.ok?{token:(await t.json()).token,error:null,isAuthError:!1}:t.status===401?{token:null,error:"Authentication failed",isAuthError:!0}:{token:null,error:`HTTP ${t.status}`,isAuthError:!1}}catch(t){return{token:null,error:t.message,isAuthError:!1}}}class HubPublisher{constructor(){this.ws=null,this.queue=[],this.retryCount=0,this.currentRoom=null,this.isConnecting=!1,this.authErrorBackoff=!1}extractRoomFromUrl(e){try{const t=e.split("?")[0].split("#")[0].replace(/\/$/,"").split("/"),n=t[t.length-1];return n&&n.trim()!==""?n:null}catch{return null}}async connect(e){if(e&&!(this.currentRoom===e&&this.ws&&this.ws.readyState===WebSocket.OPEN)&&(this.currentRoom!==e&&(this.disconnect(),this.currentRoom=e,this.retryCount=0,this.authErrorBackoff=!1),!this.isConnecting&&!(this.ws&&(this.ws.readyState===WebSocket.CONNECTING||this.ws.readyState===WebSocket.OPEN)))){this.isConnecting=!0,this.clearRetryAlarm();try{const s=await getPublisherId(e),t=await fetchHubToken({roomId:e,role:"pub",publisherId:s});if(!t.token){this.isConnecting=!1,t.isAuthError?(this.authErrorBackoff=!0,this.scheduleRetry(e,AUTH_ERROR_BACKOFF_MS)):this.scheduleRetry(e);return}this.authErrorBackoff=!1;const n=`wss://${HUB_HOST}/?room=${e}&role=pub&token=${t.token}`;this.ws=new WebSocket(n),this.ws.onopen=()=>{this.isConnecting=!1,this.retryCount=0,this.flushQueue()},this.ws.onerror=i=>{},this.ws.onclose=i=>{this.isConnecting=!1,this.ws=null,this.scheduleRetry(e)}}catch{this.isConnecting=!1,this.scheduleRetry(e)}}}scheduleRetry(e,s=null){if(this.retryCount>=MAX_RETRIES){this.clearRetryAlarm();return}this.clearRetryAlarm(),this.retryCount++;let t;s!==null?t=s:t=Math.min(INITIAL_BACKOFF_MS*Math.pow(2,this.retryCount-1),MAX_BACKOFF_MS),chrome.alarms.create(RETRY_ALARM_NAME,{when:Date.now()+t})}clearRetryAlarm(){chrome.alarms.clear(RETRY_ALARM_NAME)}disconnect(){if(this.clearRetryAlarm(),this.ws){try{this.ws.onclose=null,this.ws.close()}catch{}this.ws=null}this.isConnecting=!1}publish(e){try{const s=JSON.stringify(e);if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{this.ws.send(s)}catch{this.enqueue(e)}else this.enqueue(e)}catch{}}enqueue(e){this.queue.push(e),this.queue.length>QUEUE_CAP&&this.queue.shift()}flushQueue(){for(;this.queue.length>0&&this.ws&&this.ws.readyState===WebSocket.OPEN;){const e=this.queue.shift();try{const s=JSON.stringify(e);this.ws.send(s)}catch{this.queue.unshift(e);break}}}}const hubPublisher=new HubPublisher;chrome.alarms.onAlarm.addListener(r=>{r.name===RETRY_ALARM_NAME&&hubPublisher.currentRoom&&hubPublisher.connect(hubPublisher.currentRoom)});function handleHandData(r){if(!r.url)return;const e=hubPublisher.extractRoomFromUrl(r.url);if(!e)return;hubPublisher.connect(e);const s=({publisherId:t,pokerNowPlayerId:n})=>{const i={type:"hand",publisherId:t,pokerNowPlayerId:n||null,playerName:r.playerName||null,data:r,timestamp:Date.now()};hubPublisher.publish(i)};getPublisherId(e).then(t=>{s({publisherId:t,pokerNowPlayerId:r.playerId})}).catch(t=>{s({publisherId:generateUUID(),pokerNowPlayerId:r.playerId})})}const PORT_NAME="hand-data-port";chrome.runtime.onConnect.addListener(r=>{r.name===PORT_NAME&&(r.onMessage.addListener(e=>{try{e.type==="HAND_DATA"&&handleHandData(e.data)}catch{}}),r.onDisconnect.addListener(()=>{chrome.runtime.lastError}))}),chrome.runtime.onMessage.addListener((r,e,s)=>{try{r.type==="HAND_DATA"&&handleHandData(r.data)}catch{}return!1});
